[
  {
    "path": "compass/CompassViewController.swift",
    "content": "//\n//  CompassViewController.swift\n//  compass\n//\n//  Created by Dhars on 05/04/2017.\n//  Copyright \u00a9 2017 Dhars. All rights reserved.\n//\n\nimport UIKit\nimport CoreLocation\n\nclass CompassViewController: UIViewController {\n  @IBOutlet weak var imageView: UIImageView!\n  \n  let locationDelegate = LocationDelegate()\n  var latestLocation: CLLocation? = nil\n  var yourLocationBearing: CGFloat { return latestLocation?.bearingToLocationRadian(self.yourLocation) ?? 0 }\n  var yourLocation: CLLocation {\n    get { return UserDefaults.standard.currentLocation }\n    set { UserDefaults.standard.currentLocation = newValue }\n  }\n  \n  let locationManager: CLLocationManager = {\n    $0.requestWhenInUseAuthorization()\n    $0.desiredAccuracy = kCLLocationAccuracyBest\n    $0.startUpdatingLocation()\n    $0.startUpdatingHeading()\n    return $0\n  }(CLLocationManager())\n  \n  private func orientationAdjustment() -> CGFloat {\n    let isFaceDown: Bool = {\n      switch UIDevice.current.orientation {\n      case .faceDown: return true\n      default: return false\n      }\n    }()\n    \n    let adjAngle: CGFloat = {\n      switch UIApplication.shared.statusBarOrientation {\n      case .landscapeLeft:  return 90\n      case .landscapeRight: return -90\n      case .portrait, .unknown: return 0\n      case .portraitUpsideDown: return isFaceDown ? 180 : -180\n      }\n    }()\n    return adjAngle\n  }\n  \n    // when the view loads\n  override func viewDidLoad() {\n    super.viewDidLoad()\n    locationManager.delegate = locationDelegate\n    \n    // location of my device at all times\n    locationDelegate.locationCallback = { location in\n      self.latestLocation = location\n    }\n    \n    locationDelegate.headingCallback = { newHeading in\n      \n      func computeNewAngle(with newAngle: CGFloat) -> CGFloat {\n        let heading: CGFloat = {\n          let originalHeading = self.yourLocationBearing - newAngle.degreesToRadians\n          switch UIDevice.current.orientation {\n          case .faceDown: return -originalHeading\n          default: return originalHeading\n          }\n        }()\n        \n        return CGFloat(self.orientationAdjustment().degreesToRadians + heading)\n      }\n      \n      UIView.animate(withDuration: 0.5) {\n        let angle = computeNewAngle(with: CGFloat(newHeading))\n        self.imageView.transform = CGAffineTransform(rotationAngle: angle)\n      }\n    }\n    \n    let tapGestureRecognizer = UITapGestureRecognizer(target: self, action: #selector(CompassViewController.showMap))\n    view.addGestureRecognizer(tapGestureRecognizer)\n  }\n  \n    @objc func showMap() {\n    let storyboard = UIStoryboard(name: \"Main\", bundle: nil)\n    let mapViewController = storyboard.instantiateViewController(withIdentifier: \"MapViewController\")\n    ((mapViewController as? UINavigationController)?.viewControllers.first as? MapViewController)?.delegate = self\n    self.present(mapViewController, animated: true, completion: nil)\n  }\n}\n\nextension CompassViewController: MapViewControllerDelegate {\n  func update(location: CLLocation) {\n    yourLocation = location\n  }\n}\n"
  }
]